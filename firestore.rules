rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }

    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }

    function isNotSuspended() {
      return isAuthenticated() &&
        (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status != 'suspended');
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ===== Users =====
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) &&
        isValidString(request.resource.data.nickname, 2, 10) &&
        request.resource.data.bookTemperature == 36.5 &&
        request.resource.data.totalExchanges == 0 &&
        request.resource.data.points == 0;
      allow update: if (isOwner(userId) &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt &&
        request.resource.data.role == resource.data.role)
        || isAdmin();
      allow delete: if isAdmin();
    }

    // ===== Book Info (Community DB) =====
    match /book_info/{bookInfoId} {
      allow read: if true; // Public
      allow create: if isAuthenticated() && isNotSuspended() &&
        isValidString(request.resource.data.isbn, 10, 13) &&
        isValidString(request.resource.data.title, 1, 200);
      allow update: if isAuthenticated(); // Counter increments
      allow delete: if false;
    }

    // ===== Books (User's registered books) =====
    match /books/{bookId} {
      allow read: if true; // Public browsing
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.ownerUid == request.auth.uid;
      allow update: if isOwner(resource.data.ownerUid) || isAdmin();
      allow delete: if isOwner(resource.data.ownerUid) || isAdmin();
    }

    // ===== Exchange Requests =====
    match /exchange_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      ) || isAdmin();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.requesterUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      ) || isAdmin();
      allow delete: if false;
    }

    // ===== Purchase Requests =====
    match /purchase_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.buyerUid == request.auth.uid ||
        resource.data.sellerUid == request.auth.uid
      ) || isAdmin();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.buyerUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() && (
        resource.data.buyerUid == request.auth.uid ||
        resource.data.sellerUid == request.auth.uid
      ) || isAdmin();
      allow delete: if false;
    }

    // ===== Matches =====
    match /matches/{matchId} {
      allow read: if isAuthenticated() && (
        resource.data.userAUid == request.auth.uid ||
        resource.data.userBUid == request.auth.uid
      ) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.userAUid == request.auth.uid ||
        resource.data.userBUid == request.auth.uid
      ) || isAdmin();
      allow delete: if false;
    }

    // ===== Chat Rooms =====
    match /chat_rooms/{chatRoomId} {
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow delete: if false;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participants;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participants &&
          request.resource.data.senderUid == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
    }

    // ===== Reviews =====
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.reviewerUid == request.auth.uid &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5;
      allow update: if false;
      allow delete: if false;
    }

    // ===== Notifications =====
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.targetUid);
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.targetUid);
      allow delete: if isOwner(resource.data.targetUid);
    }

    // ===== Wishlists =====
    match /wishlists/{wishlistId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.userUid == request.auth.uid;
      allow update: if isOwner(resource.data.userUid);
      allow delete: if isOwner(resource.data.userUid);
    }

    // ===== User Settings (subcollection) =====
    match /users/{userId}/settings/{settingId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ===== Book Clubs =====
    match /book_clubs/{clubId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.creatorUid == request.auth.uid &&
        isValidString(request.resource.data.name, 2, 30);
      allow update: if isAuthenticated() && isNotSuspended();
      allow delete: if isOwner(resource.data.creatorUid) || isAdmin();

      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/book_clubs/$(clubId)).data.memberUids;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/book_clubs/$(clubId)).data.memberUids &&
          request.resource.data.senderUid == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
    }

    // ===== Reports =====
    match /reports/{reportId} {
      allow read: if isOwner(resource.data.reporterUid) || isAdmin();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.reporterUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAdmin();
      allow delete: if false;
    }

    // ===== Relay Exchanges =====
    match /relay_exchanges/{relayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended();
      allow update: if isAuthenticated();
      allow delete: if false;
    }

    // ===== Sharing Requests =====
    match /sharing_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      ) || isAdmin();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.requesterUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      ) || isAdmin();
      allow delete: if false;
    }

    // ===== Donations =====
    match /donations/{donationId} {
      allow read: if isAuthenticated() && (
        resource.data.donorUid == request.auth.uid
      ) || isAdmin();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.donorUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isOwner(resource.data.donorUid) || isAdmin();
      allow delete: if false;
    }

    // ===== Organizations =====
    match /organizations/{orgId} {
      allow read: if true; // Public
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ===== Admin =====
    match /admin/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
