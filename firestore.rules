rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }

    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }

    function isNotSuspended() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status != 'suspended';
    }

    // ===== Users =====
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) &&
        isValidString(request.resource.data.nickname, 2, 10) &&
        request.resource.data.bookTemperature == 36.5 &&
        request.resource.data.totalExchanges == 0 &&
        request.resource.data.points == 0;
      allow update: if isOwner(userId) &&
        // Cannot modify critical fields directly
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if false; // Admin only via Cloud Functions
    }

    // ===== Book Info (Community DB) =====
    match /book_info/{bookInfoId} {
      allow read: if true; // Public
      allow create: if isAuthenticated() && isNotSuspended() &&
        isValidString(request.resource.data.isbn, 10, 13) &&
        isValidString(request.resource.data.title, 1, 200);
      allow update: if isAuthenticated(); // Counter increments
      allow delete: if false;
    }

    // ===== Books (User's registered books) =====
    match /books/{bookId} {
      allow read: if true; // Public browsing
      allow create: if isAuthenticated() &&
        request.resource.data.ownerUid == request.auth.uid;
      allow update: if isOwner(resource.data.ownerUid);
      allow delete: if isOwner(resource.data.ownerUid);
    }

    // ===== Exchange Requests =====
    match /exchange_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      );
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.requesterUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() && (
        resource.data.requesterUid == request.auth.uid ||
        resource.data.ownerUid == request.auth.uid
      );
      allow delete: if false;
    }

    // ===== Matches =====
    match /matches/{matchId} {
      allow read: if isAuthenticated() && (
        resource.data.userAUid == request.auth.uid ||
        resource.data.userBUid == request.auth.uid
      );
      allow create: if isAuthenticated(); // Created by system after both agree
      allow update: if isAuthenticated() && (
        resource.data.userAUid == request.auth.uid ||
        resource.data.userBUid == request.auth.uid
      );
      allow delete: if false;
    }

    // ===== Chat Rooms =====
    match /chat_rooms/{chatRoomId} {
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow delete: if false;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participants;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participants &&
          request.resource.data.senderUid == request.auth.uid;
        allow update: if false; // Messages are immutable
        allow delete: if false;
      }
    }

    // ===== Reviews =====
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.reviewerUid == request.auth.uid &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5;
      allow update: if false; // Reviews are immutable
      allow delete: if false;
    }

    // ===== Notifications =====
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.targetUid);
      allow create: if isAuthenticated(); // System creates notifications
      allow update: if isOwner(resource.data.targetUid); // Mark as read
      allow delete: if isOwner(resource.data.targetUid);
    }

    // ===== Wishlists =====
    match /wishlists/{wishlistId} {
      allow read: if isAuthenticated(); // Allow querying by bookInfoId for matching
      allow create: if isAuthenticated() &&
        request.resource.data.userUid == request.auth.uid;
      allow update: if isOwner(resource.data.userUid);
      allow delete: if isOwner(resource.data.userUid);
    }

    // ===== User Settings (subcollection) =====
    match /users/{userId}/settings/{settingId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ===== Book Clubs =====
    match /book_clubs/{clubId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.creatorUid == request.auth.uid &&
        isValidString(request.resource.data.name, 2, 30);
      allow update: if isAuthenticated() && (
        resource.data.creatorUid == request.auth.uid ||
        request.auth.uid in resource.data.memberUids
      );
      allow delete: if isOwner(resource.data.creatorUid);
    }

    // ===== Reports =====
    match /reports/{reportId} {
      allow read: if isOwner(resource.data.reporterUid); // Reporter can see own reports
      allow create: if isAuthenticated() && isNotSuspended() &&
        request.resource.data.reporterUid == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if false; // Admin only via Cloud Functions
      allow delete: if false;
    }

    // ===== Relay Exchanges =====
    match /relay_exchanges/{relayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended();
      allow update: if isAuthenticated(); // Participants confirm
      allow delete: if false;
    }
  }
}
